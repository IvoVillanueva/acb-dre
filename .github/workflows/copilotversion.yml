on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * 1"

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes
      # Definir explícitamente R_LIBS_USER para cache y para la instalación
      R_LIBS_USER: /home/runner/work/_temp/Library

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: "release"
          use-public-rspm: true

      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: ${{ env.R_LIBS_USER }}
          # hash del script y del QMD correcto (corrige tabla_dre.qmd -> acb-dre.qmd)
          key: ${{ runner.os }}-r-v2-${{ hashFiles('scripts/*.R') }}-${{ hashFiles('acb-dre.qmd') }}
          restore-keys: |
            ${{ runner.os }}-r-v2-

      - name: Install CRAN packages
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: |
            rmarkdown
            knitr
            reactable
            htmltools
            htmlwidgets
            tidyverse
            janitor
            glue
            lubridate

      - name: Install Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Check files and _publish.yml
        run: |
          echo "PWD: $(pwd)"
          echo "List root files:"
          ls -la
          echo "Show _publish.yml if present:"
          if [ -f _publish.yml ]; then
            sed -n '1,200p' _publish.yml
          else
            echo "_publish.yml NOT found in repo root"
          fi
          echo "Check QMD exists:"
          if [ -f acb-dre.qmd ]; then
            echo "acb-dre.qmd FOUND"
          else
            echo "ERROR: acb-dre.qmd NOT found in repo root; aborting"
            exit 1
          fi

      - name: Render QMD
        run: |
          # usar R_LIBS_USER ya definido en env
          echo "R_LIBS_USER = $R_LIBS_USER"
          quarto render acb-dre.qmd
          echo "Rendered files:"
          ls -la acb-dre.* || true

      - name: Quarto info (version & help)
  run: |
    echo "Quarto version:"
    quarto --version || true
    echo
    echo "Quarto publish help (first 200 lines):"
    quarto publish --help | sed -n '1,200p' || true

- name: Quarto info (version & help)
  run: |
    echo "Quarto version:"
    quarto --version || true
    echo
    echo "Quarto publish help (first 200 lines):"
    quarto publish --help | sed -n '1,200p' || true

- name: Publish to Quarto Pub (run live, show output)
  env:
    QUARTO_PUB_TOKEN: ${{ secrets.QUARTO_PUB_TOKEN }}
  run: |
    echo "Running: quarto publish quarto-pub acb-dre.qmd --no-prompt"
    quarto publish quarto-pub acb-dre.qmd --no-prompt
    rc=$?
    echo "EXIT CODE: $rc"

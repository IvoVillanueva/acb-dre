---
title: ""
execute:
  echo: false
  warning: false
  message: false
format:
  html:
    theme: cosmo
---

```{r}
knitr::opts_chunk$set(echo = FALSE)

options(reactable.static = TRUE)
```

```{r eval=FALSE}
source("scripts/acb_dre_table.R")

tbla <- reactable(
  df %>%
    mutate(dre = round(dre, 1)) %>%
    select(-equipo, -abb, -rival, -matches, -percentil_val, -percentil_dre, -logo_cuadrado),
  columns = list(
    license_license_str15 = colDef(
      sticky = "left",
      name = "",
      width = 160,
      html = TRUE,
      cell = function(value, index) {
        htmltools::HTML(
          combine_word(
            license_license_str15 = value,
            rival = df$rival[index],
            logo_cuadrado = df$logo_cuadrado[index]
          )
        )
      }
    ),
    val = colDef(
      html = TRUE,
      minWidth = 11,
      align = "center",
      name = "Val",
      cell = function(value, index) {
        sprintf(
          "
      <div style='line-height:1; display:flex; flex-direction:column; justify-content:center;'>
      <div style='font-size:12px; padding-top:7.5px;'>%s</div>
      <div style='font-size:6px; font-weight:500; color:gray;'>%s</div>
      </div>",
          value, 
          df$percentil_val[index] 
        )
      }
    ),
    dre = colDef(
      html = TRUE,
      align = "center",
      minWidth = 11,
      name = "DRE",
      cell = function(value, index) {
        sprintf(
          "
      <div style='line-height:1; display:flex; flex-direction:column; justify-content:center;'>
        <div style='font-size:12px; padding-top:7.5px;'>%s</div>
        <div style='font-size:6px; font-weight:500;'>%s</div>
      </div>",
          value,
          df$percentil_dre[index]
        )
      },
      style = function(value, index) {
        # --- FIX ROBUSTO ---
        
        # 1. Protección contra NAs
        if (is.na(value)) {
          return(list(background = "#ffffff", color = "#000000"))
        }

        # 2. Calculamos min y max (usando el df original para el rango real)
        min_dre <- min(df$dre, na.rm = TRUE)
        max_dre <- max(df$dre, na.rm = TRUE)
        
        if (max_dre == min_dre) {
           return(list(background = "#ffffff", color = "#000000"))
        }

        # 3. Calculamos la escala
        scaled_bg <- (value - min_dre) / (max_dre - min_dre)
        
        # 4. --- CLAMPING (NUEVO) ---
        # Esto es vital: corrige el error causado por redondear 'dre' a 1 decimal.
        # Si value (12.6) < min_dre (12.64), scaled sería negativo. Esto lo fuerza a ser 0.
        scaled_bg <- max(0, min(1, scaled_bg))
        
        # Generamos el color
        background_color <- dre_rating_color(scaled_bg)

        # Calculamos el color de la fuente
        font_color <- make_font_pal(index, df$percentil_dre)

        list(
          background = background_color,
          color = font_color
        )
      }
    ),
    time_played = colDef(name = "Min", minWidth = 15, align = "right", vAlign = "center"),
    ts_pct = colDef(name = "Ts%", minWidth = 15, align = "right", vAlign = "center"),
    usg_pct = colDef(name = "Usg%", minWidth = 15, align = "right", vAlign = "center"),
    points = colDef(name = "Pts", minWidth = 10, vAlign = "center"),
    asis = colDef(name = "Ast", minWidth = 10, vAlign = "center"),
    total_rebound = colDef(name = "Reb", minWidth = 10, vAlign = "center"),
    turnovers = colDef(name = "Tot", minWidth = 10, vAlign = "center"),
    steals = colDef(name = "Stl", minWidth = 10, vAlign = "center"),
    blocks = colDef(name = "Blk", minWidth = 10, vAlign = "center"),
    x2pm_a = colDef(name = "2pt", minWidth = 12, align = "right", vAlign = "center"),
    x3pm_a = colDef(name = "3pt", minWidth = 12, align = "right", vAlign = "center"),
    x1pm_a = colDef(name = "1pt", minWidth = 12, align = "right", vAlign = "center"),
    differential = colDef(name = "+/-", minWidth = 11, align = "right", vAlign = "center")
  ),
  pagination = TRUE,
  filterable = TRUE,
  highlight = TRUE,
  height ="100%",
  width = "100%",
  defaultPageSize = 25,
  theme = reactableTheme(
    header = list(
      borderBottom = "3px solid black",
      textAlign = "center" 
    ),
    style = list(
      fontFamily = "Oswald",
      fontSize = "12px"
    )
  )
)

div(
  logo_header,
  tbla,
  div(
    class = "caption",
    caption
  )
)

```

```{r font_styles, eval=FALSE}
htmltools::tags$link(
  href = "https://fonts.googleapis.com/css2?family=Oswald:wght@200;300;400;500;600;700&display=swap",
  rel  = "stylesheet",
  htmltools::tags$link( 
  href="path/to/font-awesome/css/font-awesome.min.css",
  rel="stylesheet" )
)
```


```{css styles}

.caption{
  margin-top:1rem;
  font-family: Oswald, sans-serif;
  font-size: .5rem;
}
```
